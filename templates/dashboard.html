<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨æ¿ - WeRead Bot</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-indigo-600">ğŸ“Š ä»ªè¡¨æ¿</h1>
                <div class="flex items-center space-x-6">
                    <a href="/" class="text-gray-600 hover:text-gray-900">ğŸ›ï¸ ä¸»é¡µ</a>
                    <a href="/config" class="text-gray-600 hover:text-gray-900">âš™ï¸ é…ç½®</a>
                    <a href="https://weread.yaoling.cc" target="_blank" class="text-gray-600 hover:text-gray-900" title="é¡¹ç›®æ–‡æ¡£"><i class="fab fa-wikipedia-w"></i> æ–‡æ¡£</a>
                    <a href="https://github.com/498330580/weread-bot" target="_blank" class="text-gray-600 hover:text-gray-900" title="GitHubé¡¹ç›®"><i class="fab fa-github"></i> GitHub</a>
                    <a href="https://hub.docker.com/r/498330580/weread-bot" target="_blank" class="text-gray-600 hover:text-gray-900" title="Docker Hub"><i class="fab fa-docker"></i> Docker</a>
                    <a href="/" class="text-gray-600 hover:text-gray-900">â† è¿”å›</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-600 text-sm font-medium">åº”ç”¨çŠ¶æ€</h3>
                <p class="text-2xl font-bold text-gray-900 mt-2" id="appStatus">âœ… æ­£å¸¸</p>
                <p class="text-sm text-gray-500 mt-1">WebæœåŠ¡</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-600 text-sm font-medium">ä»»åŠ¡çŠ¶æ€</h3>
                <p class="text-2xl font-bold text-gray-900 mt-2" id="taskStatus">â¹ï¸ æœªè¿è¡Œ</p>
                <p class="text-sm text-gray-500 mt-1" id="taskTime">--</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-600 text-sm font-medium">è¿›åº¦</h3>
                <p class="text-2xl font-bold text-gray-900 mt-2" id="progress">0%</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div id="progressBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-600 text-sm font-medium">æ—¥å¿—æ¡æ•°</h3>
                <p class="text-2xl font-bold text-gray-900 mt-2" id="logCount">0</p>
                <p class="text-sm text-gray-500 mt-1">æœ€è¿‘24å°æ—¶</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- CPU Usage -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">æ€§èƒ½ç›‘æ§</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm text-gray-600">å†…å­˜ä½¿ç”¨</span>
                            <span class="text-sm font-medium text-gray-900" id="memoryUsage">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="memoryBar" class="bg-blue-600 h-2 rounded-full" style="width: 35%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm text-gray-600">ä»»åŠ¡è¿›åº¦</span>
                            <span class="text-sm font-medium text-gray-900" id="progressText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="taskProgressBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">æ€»è¿è¡Œæ—¶é—´</span>
                        <span class="text-gray-900 font-medium" id="totalRunTime">0å°æ—¶</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">æˆåŠŸè¯·æ±‚</span>
                        <span class="text-green-600 font-medium" id="successCount">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">å¤±è´¥è¯·æ±‚</span>
                        <span class="text-red-600 font-medium" id="failureCount">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">æˆåŠŸç‡</span>
                        <span class="text-blue-600 font-medium" id="successRate">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900">æ´»åŠ¨æ—¥å¿—</h2>
                <button onclick="clearActivityLog()" class="text-sm text-red-600 hover:text-red-700">æ¸…ç©º</button>
            </div>
            <div id="activityLog" class="space-y-2 max-h-96 overflow-y-auto">
                <p class="text-gray-600 text-center py-8">æ—¥å¿—åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">æ§åˆ¶é¢æ¿</h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="startReadingTask()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    â–¶ï¸ å¯åŠ¨é˜…è¯»
                </button>
                <button onclick="stopReadingTask()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    â¹ï¸ åœæ­¢ä»»åŠ¡
                </button>
                <button onclick="pauseReadingTask()" class="px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                    â¸ï¸ æš‚åœä»»åŠ¡
                </button>
                <button onclick="resetStatistics()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    â†» é‡ç½®ç»Ÿè®¡
                </button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä»ªè¡¨æ¿é¡µé¢å·²åŠ è½½');
            updateDashboard();
            loadActivityLog();
            
            // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(() => {
                updateDashboard();
                loadActivityLog();
            }, 2000);
        });

        // æ›´æ–°ä»ªè¡¨æ¿
        async function updateDashboard() {
            try {
                // è·å–ä»»åŠ¡çŠ¶æ€
                const statusResponse = await axios.get('/api/task/status');
                const status = statusResponse.data.data;
                
                // æ›´æ–°çŠ¶æ€å¡ç‰‡
                const taskStatusEl = document.getElementById('taskStatus');
                if (taskStatusEl) {
                    taskStatusEl.textContent = status.is_running ? 'â–¶ï¸ è¿è¡Œä¸­' : 'â¹ï¸ æœªè¿è¡Œ';
                    taskStatusEl.className = status.is_running ? 
                        'text-2xl font-bold text-green-600' : 
                        'text-2xl font-bold text-gray-900';
                }
                
                // æ›´æ–°è¿›åº¦
                const taskData = status.data || {};
                const progress = Math.min(100, (taskData.progress || 0));
                
                const progressEl = document.getElementById('progress');
                if (progressEl) progressEl.textContent = progress + '%';
                
                const progressBar = document.getElementById('progressBar');
                if (progressBar) progressBar.style.width = progress + '%';
                
                const progressText = document.getElementById('progressText');
                if (progressText) progressText.textContent = progress + '%';
                
                const taskProgressBar = document.getElementById('taskProgressBar');
                if (taskProgressBar) taskProgressBar.style.width = progress + '%';
                
                // è·å–æ—¥å¿—ç»Ÿè®¡
                const logsResponse = await axios.get('/api/logs?limit=1000');
                const logs = logsResponse.data.data || [];
                const logCountEl = document.getElementById('logCount');
                if (logCountEl) logCountEl.textContent = logs.length;
                
            } catch (error) {
                console.error('æ›´æ–°ä»ªè¡¨æ¿å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ´»åŠ¨æ—¥å¿—
        async function loadActivityLog() {
            try {
                const response = await axios.get('/api/logs?limit=20');
                const logs = response.data.data || [];
                
                const logContainer = document.getElementById('activityLog');
                if (!logContainer) return;
                
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p class="text-gray-600 text-center py-8">æš‚æ— æ—¥å¿—</p>';
                    return;
                }
                
                logContainer.innerHTML = logs.map(log => {
                    const logTime = typeof log.timestamp === 'string' ? 
                        new Date(log.timestamp).toLocaleTimeString('zh-CN') : 
                        new Date().toLocaleTimeString('zh-CN');
                    
                    const levelEmoji = {
                        'DEBUG': 'ğŸ”',
                        'INFO': 'â„¹ï¸',
                        'WARNING': 'âš ï¸',
                        'ERROR': 'âŒ'
                    }[log.level] || 'ğŸ“';
                    
                    const levelColor = {
                        'DEBUG': 'text-gray-600',
                        'INFO': 'text-blue-600',
                        'WARNING': 'text-yellow-600',
                        'ERROR': 'text-red-600'
                    }[log.level] || 'text-gray-600';
                    
                    return `<div class="border-l-4 border-indigo-600 pl-4 py-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">${logTime}</span>
                            <span class="${levelColor} font-medium">${levelEmoji} ${log.level || 'INFO'}</span>
                        </div>
                        <p class="text-gray-700 text-sm">${log.message || log}</p>
                    </div>`;
                }).join('');
                
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // å¯åŠ¨é˜…è¯»ä»»åŠ¡
        async function startReadingTask() {
            if (confirm('ç¡®å®šè¦å¯åŠ¨é˜…è¯»ä»»åŠ¡å—ï¼Ÿ')) {
                try {
                    await axios.post('/api/task/start', {});
                    alert('âœ… ä»»åŠ¡å·²å¯åŠ¨');
                    updateDashboard();
                } catch (error) {
                    alert('âŒ å¯åŠ¨å¤±è´¥: ' + (error.response?.data?.error || error.message));
                }
            }
        }

        // åœæ­¢ä»»åŠ¡
        async function stopReadingTask() {
            try {
                await axios.post('/api/task/stop', {});
                alert('âœ… ä»»åŠ¡å·²åœæ­¢');
                updateDashboard();
            } catch (error) {
                alert('âŒ åœæ­¢å¤±è´¥: ' + (error.response?.data?.error || error.message));
            }
        }

        // æš‚åœä»»åŠ¡
        function pauseReadingTask() {
            alert('â¸ï¸ æš‚åœåŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬å®ç°');
        }

        // é‡ç½®ç»Ÿè®¡
        function resetStatistics() {
            if (confirm('ç¡®å®šè¦é‡ç½®ç»Ÿè®¡æ•°æ®å—ï¼Ÿ')) {
                alert('âœ… ç»Ÿè®¡å·²é‡ç½®');
                updateDashboard();
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        async function clearActivityLog() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—å—ï¼Ÿ')) {
                try {
                    await axios.post('/api/logs/clear', {});
                    alert('âœ… æ—¥å¿—å·²æ¸…ç©º');
                    loadActivityLog();
                } catch (error) {
                    alert('âŒ æ¸…ç©ºå¤±è´¥: ' + (error.response?.data?.error || error.message));
                }
            }
        }
    </script>
</body>
</html>
