<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeRead Bot - Webç‰ˆå¾®ä¿¡è¯»ä¹¦é˜…è¯»æœºå™¨äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <style>
        .btn-primary { @apply px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors; }
        .btn-secondary { @apply px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors; }
        .badge { @apply inline-block px-3 py-1 rounded-full text-sm font-medium; }
        .badge-success { @apply bg-green-100 text-green-800; }
        .badge-danger { @apply bg-red-100 text-red-800; }
        .badge-warning { @apply bg-yellow-100 text-yellow-800; }
        .badge-info { @apply bg-blue-100 text-blue-800; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600">ğŸ“š WeRead Bot</h1>
                    <span class="ml-4 text-sm text-gray-600">Webç‰ˆå¾®ä¿¡è¯»ä¹¦é˜…è¯»æœºå™¨äºº</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-700 hover:text-gray-900 font-medium">ä¸»é¡µ</a>
                    <a href="/dashboard" class="text-gray-700 hover:text-gray-900 font-medium">ğŸ“Š ä»ªè¡¨æ¿</a>
                    <a href="/config" class="text-gray-700 hover:text-gray-900 font-medium">âš™ï¸ é…ç½®</a>
                    <div id="taskStatus" class="badge badge-info">å°±ç»ª</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="space-y-8">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-600 text-sm font-medium">åº”ç”¨çŠ¶æ€</h3>
                    <p class="text-2xl font-bold text-gray-900 mt-2" id="appStatus">è¿è¡Œä¸­</p>
                    <p class="text-sm text-gray-500 mt-1">WebæœåŠ¡æ­£å¸¸</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-600 text-sm font-medium">ä»»åŠ¡çŠ¶æ€</h3>
                    <p class="text-2xl font-bold text-gray-900 mt-2" id="taskStatusText">æœªè¿è¡Œ</p>
                    <p class="text-sm text-gray-500 mt-1" id="taskTime">å°±ç»ª</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-600 text-sm font-medium">è¿›åº¦</h3>
                    <p class="text-2xl font-bold text-gray-900 mt-2" id="taskProgress">0%</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-600 text-sm font-medium">é…ç½®æ–‡ä»¶</h3>
                    <p class="text-2xl font-bold text-gray-900 mt-2">config.yaml</p>
                    <p class="text-sm text-gray-500 mt-1">å·²åŠ è½½</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">å¿«é€Ÿæ“ä½œ</h2>
                <div class="flex flex-wrap gap-4">
                    <button onclick="startTask()" class="btn-primary">
                        â–¶ï¸ å¯åŠ¨ä»»åŠ¡
                    </button>
                    <button onclick="stopTask()" class="btn-secondary">
                        â¹ï¸ åœæ­¢ä»»åŠ¡
                    </button>
                    <button onclick="navigateTo('config')" class="btn-secondary">
                        âš™ï¸ ç¼–è¾‘é…ç½®
                    </button>
                    <button onclick="downloadConfig()" class="btn-secondary">
                        â¬‡ï¸ å¯¼å‡ºé…ç½®
                    </button>
                    <button onclick="document.getElementById('configFile').click()" class="btn-secondary">
                        â¬†ï¸ å¯¼å…¥é…ç½®
                    </button>
                    <input type="file" id="configFile" accept=".yaml,.yml" style="display:none;" onchange="uploadConfig(event)">
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">æœ€è¿‘æ—¥å¿—</h2>
                    <button onclick="clearLogs()" class="text-sm text-red-600 hover:text-red-700">æ¸…ç©º</button>
                </div>
                <div id="logContainer" class="bg-gray-50 rounded p-4 font-mono text-sm max-h-96 overflow-y-auto">
                    <p class="text-gray-600">æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                </div>
            </div>
        </div>

        <!-- Config Section -->
        <div id="configSection" style="display:none;" class="space-y-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">é…ç½®ç¼–è¾‘</h2>
                <textarea id="configEditor" class="w-full h-96 p-4 border border-gray-300 rounded-lg font-mono text-sm"
                    placeholder="YAMLé…ç½®å†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤..."></textarea>
                <div class="flex gap-4 mt-4">
                    <button onclick="saveConfig()" class="btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button onclick="reloadConfig()" class="btn-secondary">ğŸ”„ é‡æ–°åŠ è½½</button>
                    <button onclick="resetConfig()" class="btn-secondary">â†» æ¢å¤é»˜è®¤</button>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" style="display:none;" class="space-y-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">å®Œæ•´æ—¥å¿—</h2>
                    <div class="space-x-2">
                        <button onclick="clearLogs()" class="btn-secondary">æ¸…ç©ºæ—¥å¿—</button>
                        <button onclick="downloadLogs()" class="btn-secondary">ä¸‹è½½æ—¥å¿—</button>
                    </div>
                </div>
                <div id="fullLogContainer" class="bg-gray-50 rounded p-4 font-mono text-sm max-h-96 overflow-y-auto">
                    <p class="text-gray-600">æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 'dashboard';
        let taskCheckInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            startTaskMonitoring();
        });

        // é¡µé¢å¯¼èˆª
        function navigateTo(page) {
            currentPage = page;
            document.getElementById('dashboardSection').style.display = page === 'dashboard' ? 'block' : 'none';
            document.getElementById('configSection').style.display = page === 'config' ? 'block' : 'none';
            document.getElementById('logsSection').style.display = page === 'logs' ? 'block' : 'none';
            
            if (page === 'config') {
                loadConfig();
            } else if (page === 'logs') {
                loadFullLogs();
            }
        }

        // å¯åŠ¨ä»»åŠ¡
        async function startTask() {
            try {
                const response = await axios.post('/api/task/start', {});
                showNotification('âœ… ä»»åŠ¡å·²å¯åŠ¨', 'success');
                setTimeout(loadDashboard, 1000);
            } catch (error) {
                showNotification('âŒ å¯åŠ¨å¤±è´¥: ' + error.response?.data?.error, 'error');
            }
        }

        // åœæ­¢ä»»åŠ¡
        async function stopTask() {
            try {
                const response = await axios.post('/api/task/stop', {});
                showNotification('â¹ï¸ ä»»åŠ¡å·²åœæ­¢', 'success');
                setTimeout(loadDashboard, 1000);
            } catch (error) {
                showNotification('âŒ åœæ­¢å¤±è´¥: ' + error.response?.data?.error, 'error');
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            try {
                const response = await axios.get('/api/task/status');
                const status = response.data.data;
                
                document.getElementById('taskStatusText').textContent = 
                    status.is_running ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ';
                document.getElementById('taskStatus').textContent = 
                    status.is_running ? 'è¿è¡Œä¸­' : 'å°±ç»ª';
                document.getElementById('taskStatus').className = 
                    status.is_running ? 'badge badge-success' : 'badge badge-info';
                
                loadLogs();
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs(limit = 20) {
            try {
                const response = await axios.get('/api/logs?limit=' + limit);
                const logs = response.data.data;
                const logContainer = document.getElementById('logContainer');
                
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p class="text-gray-600">æ²¡æœ‰æ—¥å¿—</p>';
                    return;
                }
                
                logContainer.innerHTML = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('zh-CN');
                    const levelClass = {
                        'DEBUG': 'text-gray-600',
                        'INFO': 'text-blue-600',
                        'WARNING': 'text-yellow-600',
                        'ERROR': 'text-red-600'
                    }[log.level] || 'text-gray-600';
                    
                    return `<div class="mb-1">
                        <span class="text-gray-500">[${time}]</span>
                        <span class="${levelClass} font-medium">[${log.level}]</span>
                        <span class="text-gray-700">${log.message}</span>
                    </div>`;
                }).join('');
                
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // åŠ è½½å®Œæ•´æ—¥å¿—
        async function loadFullLogs(limit = 500) {
            try {
                const response = await axios.get('/api/logs?limit=' + limit);
                const logs = response.data.data;
                const logContainer = document.getElementById('fullLogContainer');
                
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p class="text-gray-600">æ²¡æœ‰æ—¥å¿—</p>';
                    return;
                }
                
                logContainer.innerHTML = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('zh-CN');
                    const levelClass = {
                        'DEBUG': 'text-gray-600',
                        'INFO': 'text-blue-600',
                        'WARNING': 'text-yellow-600',
                        'ERROR': 'text-red-600'
                    }[log.level] || 'text-gray-600';
                    
                    return `<div class="mb-1">
                        <span class="text-gray-500">[${time}]</span>
                        <span class="${levelClass} font-medium">[${log.level}]</span>
                        <span class="text-gray-700">${log.message}</span>
                    </div>`;
                }).join('');
                
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
            
            try {
                await axios.post('/api/logs/clear', {});
                showNotification('âœ… æ—¥å¿—å·²æ¸…ç©º', 'success');
                loadLogs();
                loadFullLogs();
            } catch (error) {
                showNotification('âŒ æ¸…ç©ºå¤±è´¥: ' + error.response?.data?.error, 'error');
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await axios.get('/api/config');
                const config = response.data.data;
                document.getElementById('configEditor').value = JSON.stringify(config, null, 2);
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            try {
                const configText = document.getElementById('configEditor').value;
                const config = JSON.parse(configText);
                
                const response = await axios.post('/api/config', config);
                showNotification('âœ… é…ç½®å·²ä¿å­˜', 'success');
            } catch (error) {
                showNotification('âŒ ä¿å­˜å¤±è´¥: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        // é‡æ–°åŠ è½½é…ç½®
        async function reloadConfig() {
            loadConfig();
            showNotification('âœ… é…ç½®å·²é‡æ–°åŠ è½½', 'success');
        }

        // æ¢å¤é»˜è®¤é…ç½®
        async function resetConfig() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é…ç½®å—ï¼Ÿ')) return;
            
            try {
                // è¿™ä¸ªåŠŸèƒ½éœ€è¦åœ¨åç«¯å®ç°
                showNotification('è¯·ä½¿ç”¨APIæ‰‹åŠ¨æ¢å¤é»˜è®¤é…ç½®', 'info');
            } catch (error) {
                showNotification('âŒ æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹è½½é…ç½®
        async function downloadConfig() {
            try {
                window.location.href = '/api/export/config';
                showNotification('âœ… é…ç½®æ–‡ä»¶å·²ä¸‹è½½', 'success');
            } catch (error) {
                showNotification('âŒ ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹è½½æ—¥å¿—
        async function downloadLogs() {
            try {
                window.location.href = '/api/logs/download';
                showNotification('âœ… æ—¥å¿—æ–‡ä»¶å·²ä¸‹è½½', 'success');
            } catch (error) {
                showNotification('âŒ ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸Šä¼ é…ç½®
        async function uploadConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await axios.post('/api/import/config', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                showNotification('âœ… é…ç½®å·²å¯¼å…¥', 'success');
                setTimeout(loadDashboard, 1000);
            } catch (error) {
                showNotification('âŒ å¯¼å…¥å¤±è´¥: ' + error.response?.data?.error, 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // å¯ä»¥é›†æˆtoasté€šçŸ¥åº“
        }

        // ç›‘æ§ä»»åŠ¡çŠ¶æ€
        function startTaskMonitoring() {
            taskCheckInterval = setInterval(() => {
                if (currentPage === 'dashboard') {
                    loadDashboard();
                }
            }, 2000);
        }

        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (taskCheckInterval) {
                clearInterval(taskCheckInterval);
            }
        });
    </script>
</body>
</html>
